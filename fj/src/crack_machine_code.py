import random
import time
import re
from pprint import pprint
from itertools import ifilter
from tstream_parser import parse_number, parse_chambers
from tstream_composer import compose_number, compose_row, compose_matrix, compose_matrices

from submit_car import submit_car as submit_car_orig

def submit_car(car, cdr):
    print '=' * 5 + ' ' + car + ' ' + '=' * 5 
    res = submit_car_orig(car.replace(' ', ''), cdr)
    return re.sub(r'^\s*circuit output starts with\s*[012]*\s*this is a legal prefix\s*', '', res)
    

fuel = """
0R:
1LX0#2L1L,
0R3L0#0L2R,
0L1R0#X3R,
5L2R0#1R4L,
3R4R0#6R4R,
7R7L0#3L7L,
6R4L0#7R6L,
5R6L0#5R5L:
2L
"""

def pause():
    time.sleep(1.0  + random.random())
    
def clean_stream(s):
    return ifilter(lambda c: c in '012', s)

numbers = """
0 - 0
10 - 1
11 - 2
12 - 3
22000 - 4
22022 - 12
2210000 - 13
2210222 - 39
22110000 - 40
22112222 - 120
221200000 - 121
221222222 - 363
2222000000000 - 364
2222000222222 - 1092
22220010000000 - 1093
22220012222222 - 3279
222200200000000 - 3280
222200222222222 - 9840
2222010000000000 - 9841
2222010222222222 - 29523
22220110000000000 - 29524
22220112222222222 - 88572
222201200000000000 - 88573
222201222222222222 - 265719
"""
numbers = filter(None, (s.strip() for s in numbers.split('\n')))
numbers = [(src.strip(), int(ref)) for src, ref in (s.split('-') for s in numbers)] 


def test_parse_number():
    for src, ref in numbers:
        assert parse_number(clean_stream(src)) == ref
    print 'parse_number works, yay!' 
       
def test_compose_number():
    for src, ref in numbers:
        assert compose_number(ref) == src
    print 'compose_number works, yay!' 

test_parse_number()
test_compose_number()
pprint(parse_chambers(clean_stream('2222111002221001000221100111022100100022120011121022100100022120120111022100100022121201110022100220002200002211011220002200022100220002200102211022001112200022101011002211111110022101011002211121110022101011002212111110120221011010022111110011221101002200002212001022000112211010120022120011121022110101200221201110120221101012002212120111002211010220010022120011102200122110102200110022120122200110102211010220011002212022001101110221101102200002212002200011112211011220011002212022001111110221101122001100221202200111121022110122200022000022120112200012220002211022000010022121200102200022110220002200022000022120112200022000220002211022001220002200002212011220012200022000221110010002212101001202211100220000022121022000001222111002200000221222000100002211101022000002212102200011100221110110100221211111001022111011022000022121122000010122211101112002212111211100221110112200100221211101202200122111012110022121110121202211101222000002212220001112100221110220000120221222000121110022111022000120022122200011100122211102200022001002212122200122000100221110220011000221222001101110022111022001110022121122001100122211102200122000002212112200122000100221111010002212111000112211110100022121110011022111101110022121111121002211110220000022121222000110022111102200010022121110011220002211110220002200002212112200001122000221111022000220000221212220000112200022111110100022121011100122211111022000220000221210112200022000122211111022000220000221211101122000220002211112200101002212022001121011221111220010100221211100220011122111122001010022122200110011122211112200102200002212110220011122000221111220010220000221211110220012200022111122001102200002212121110220012200022112200001000221200112200010221122000010002212220001011002211220000102200102212220000220011011221122000010220010221222000100220011122112200002200000221212220002200000221122000022000100221211220001002200022112200002200022001022120220011122000220002211220001010002212102200011100221122000101100221222000121110022112200010220002200102212220001022001112200022112200011010022121210011220002211220002200101002212220000220011011221122001022000220000221201122000220012200022112200110110022121112102200102211220011102200002212022001121122000')))
pprint(compose_row([2]))

pprint(compose_matrices([[[2]]]))

#print submit_car(new, fuel)
